##############################################################################
# defaults
##############################################################################
.DEFAULT_GOAL := help

VENV ?= .venv


##############################################################################
# help
##############################################################################
.PHONY: help
help:
	@echo 'Usage: make [target] [argument=value] ...'
	@echo
	@echo 'Targets:'
	@echo
	@egrep '^(.+)\:\s+##\ (.+)' ${MAKEFILE_LIST} | column -t -c 2 -s ':#'


##############################################################################
# all
##############################################################################
.PHONY: all
all: ## run all targets
all: clean build lint test


##############################################################################
# build
##############################################################################
.PHONY: build
build: ## run build
build: depends


##############################################################################
# clean
##############################################################################
.PHONY: clean
clean: ## run clean
clean:
	rm -rf ${VENV}


##############################################################################
# depends
##############################################################################
.PHONY: depends
depends: ## run depends
depends: | ${VENV}

${VENV}:
	python3 -m venv ${VENV}
	${VENV}/bin/pip install .


##############################################################################
# lint
##############################################################################
.PHONY: lint
lint: ## run lint
lint: depends


##############################################################################
# test
##############################################################################
.PHONY: test
test: ## run test
test: build
	${VENV}/bin/coverage run --omit=${VENV}/*,tests/* --branch --module unittest --verbose tests/test_*.py
	${VENV}/bin/coverage xml --omit=${VENV}/*,tests/*
	${VENV}/bin/coverage report --show-missing --omit=${VENV}/*,tests/* --fail-under=90
